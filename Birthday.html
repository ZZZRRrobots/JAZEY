<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Birthday - Jaidaa</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #010102; font-family: 'Segoe UI', sans-serif; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10; display: flex; flex-direction: column;
            justify-content: space-between; align-items: center; padding: 20px 0;
            color: white; text-align: center;
        }
        #wishes {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 90%; text-align: center; z-index: 15; opacity: 0; transition: opacity 1s;
            font-size: clamp(16px, 4vw, 22px); color: #00eaff; pointer-events: auto;
        }
        span.jump { animation: jump 0.25s 2 alternate; color: #fff; text-shadow: 0 0 10px #00eaff; display: inline-block; }
        @keyframes jump { to { transform: translateY(-0.7em); } }
        
        #open-btn {
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            padding: 12px 30px; background: rgba(0, 234, 255, 0.1); border: 1px solid #00eaff;
            color: #00eaff; cursor: pointer; border-radius: 50px; display: none; z-index: 210;
        }
        #final-letter {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 500px; color: white; text-align: center;
            z-index: 250; opacity: 0; display: none; transition: opacity 2s;
            background: rgba(0, 0, 0, 0.9); padding: 30px; border-radius: 20px;
            backdrop-filter: blur(15px); border: 1px solid #00eaff;
        }
        #countdown { font-size: clamp(1.5rem, 8vw, 3rem); font-weight: bold; cursor: pointer; pointer-events: auto; }
        #hand-monitor { position: absolute; bottom: 10px; right: 10px; width: 100px; height: 75px; border: 1px solid #00eaff; border-radius: 8px; overflow: hidden; background: #000; transform: scaleX(-1); }
        #webcam-video { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; }
        #gesture-prompt { position: absolute; bottom: 120px; color: #00eaff; font-size: 0.7rem; width: 100%; text-align: center; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="wishes"><p id="p1"></p><p id="p2"></p><p id="p3"></p><p id="p4"></p></div>
    <button id="open-btn">READ MY MESSAGE</button>
    <div id="final-letter">
        <h2>To Jaidaa,</h2>
        <p>Happy Birthday! You make every moment brighter, and I am so grateful for our friendship. I hope your day is as incredible as you are!</p>
    </div>

    <div id="hand-monitor"><video id="webcam-video" autoplay playsinline muted></video></div>
    <div id="gesture-prompt">USE GESTURES 1-4 OR KEYS 1-4</div>

    <div id="ui-layer">
        <div><h1 style="font-size: 0.8rem;">Happy Birthday</h1><h2 id="name-display" style="font-size: 3rem;">JUJU</h2></div>
        <div><div id="countdown">STARTING...</div></div>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
        import { EffectComposer } from 'https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        const CONFIG = { total: 8000, targetDate: new Date("June 3, 2026").getTime() };
        let appState = "COUNTDOWN", currentShape = 1;

        // --- THREE JS SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 60;
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.6, 0.4, 0.85));

        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(CONFIG.total * 3);
        const tar = new Float32Array(CONFIG.total * 3);
        const vel = new Float32Array(CONFIG.total * 3);
        const col = new Float32Array(CONFIG.total * 3);

        function updateTargets(shape) {
            currentShape = shape;
            for(let i=0; i<CONFIG.total; i++) {
                const i3 = i * 3;
                let tx, ty, tz = (Math.random()-0.5)*5;
                if(shape === 1) { // Cake
                    let r = Math.random();
                    if(r < 0.7) { const rad = Math.sqrt(Math.random())*12; const ang = Math.random()*Math.PI*2; tx = rad*Math.cos(ang); ty = (Math.random()*8)-10; }
                    else { tx = (Math.random()-0.5)*8; ty = (Math.random()*6)+2; }
                } else if(shape === 2) { // Candle
                    if(i < CONFIG.total*0.8) { tx = (Math.random()-0.5)*5; ty = (Math.random()*25)-10; }
                    else { tx = (Math.random()-0.5)*3; ty = 16+(Math.random()*5); }
                } else if(shape === 3) { // 15
                    if(i < CONFIG.total*0.4) { tx = -8; ty = (Math.random()*20)-10; }
                    else { let ang = (Math.random()*Math.PI*1.5)-Math.PI/2; tx = 5+Math.cos(ang)*7; ty = -2+Math.sin(ang)*7; }
                } else { // Gemini
                    let r = Math.random();
                    if(r < 0.4) { tx = (i%2==0 ? -7 : 7); ty = (Math.random()*24)-12; }
                    else { tx = (Math.random()*20)-10; ty = (r > 0.7 ? 14 : -14); }
                }
                tar[i3] = tx; tar[i3+1] = ty; tar[i3+2] = tz;
            }
        }

        updateTargets(1);
        for(let i=0; i<CONFIG.total*3; i++) { pos[i] = (Math.random()-0.5)*200; col[i] = Math.random(); }
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        geo.setAttribute('target', new THREE.BufferAttribute(tar, 3));
        geo.setAttribute('velocity', new THREE.BufferAttribute(vel, 3));
        geo.setAttribute('color', new THREE.BufferAttribute(col, 3));
        scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.3, vertexColors: true, blending: THREE.AdditiveBlending })));

        // --- HAND DETECTION (MEDIA PIPE) ---
        let handPos = new THREE.Vector3(1000,1000,1000);
        async function loadAI() {
            try {
                const { FilesetResolver, HandLandmarker } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/+esm");
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm");
                const handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task" },
                    runningMode: "VIDEO"
                });
                const video = document.getElementById('webcam-video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadeddata = () => {
                    const run = () => {
                        const res = handLandmarker.detectForVideo(video, performance.now());
                        if(res.landmarks?.[0]) {
                            const l = res.landmarks[0];
                            handPos.set((0.5-l[8].x)*80, (0.5-l[8].y)*55, 0);
                            let f = 0;
                            if(l[8].y < l[6].y) f++; if(l[12].y < l[10].y) f++; if(l[16].y < l[14].y) f++; if(l[20].y < l[18].y) f++;
                            if(f > 0 && f <= 4 && f !== currentShape) updateTargets(f);
                        }
                        requestAnimationFrame(run);
                    };
                    run();
                };
            } catch(e) { console.log("AI Fallback to Keys"); }
        }
        loadAI();

        // --- FALLBACK KEYS ---
        window.addEventListener('keydown', (e) => {
            if(["1","2","3","4"].includes(e.key)) updateTargets(parseInt(e.key));
        });

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            const p = geo.attributes.position.array, t = geo.attributes.target.array, v = geo.attributes.velocity.array;
            for(let i=0; i<CONFIG.total; i++) {
                const i3 = i * 3;
                p[i3] += v[i3]; p[i3+1] += v[i3+1]; p[i3+2] += v[i3+2];
                v[i3] *= 0.9; v[i3+1] *= 0.9; v[i3+2] *= 0.9;
                const dx = p[i3]-handPos.x, dy = p[i3+1]-handPos.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 10) { v[i3] += (dx/dist)*0.5; v[i3+1] += (dy/dist)*0.5; }
                const s = 0.08;
                p[i3] += (t[i3]-p[i3])*s; p[i3+1] += (t[i3+1]-p[i3+1])*s; p[i3+2] += (t[i3+2]-p[i3+2])*s;
            }
            geo.attributes.position.needsUpdate = true;
            composer.render();
        }
        animate();

        // --- COUNTDOWN ---
        setInterval(() => {
            const diff = CONFIG.targetDate - Date.now();
            const d = Math.floor(diff/864e5), h = Math.floor(diff%864e5/36e5), m = Math.floor(diff%36e5/6e4), s = Math.floor(diff%6e4/1e3);
            document.getElementById('countdown').innerText = diff > 0 ? `${d}:${h}:${m}:${s}` : "READY!";
        }, 1000);

        // --- FINAL REVEAL ---
        document.getElementById('countdown').onclick = () => {
            appState = "REVEAL";
            document.getElementById('ui-layer').style.display = "none";
            document.getElementById('wishes').style.opacity = "1";
            document.getElementById('open-btn').style.display = "block";
            // Set random scatter
            for(let i=0; i<CONFIG.total*3; i++) tar[i] = (Math.random()-0.5)*150;
        };

        document.getElementById('open-btn').onclick = () => {
            document.getElementById('final-letter').style.display = "block";
            setTimeout(() => document.getElementById('final-letter').style.opacity = "1", 100);
        };
    </script>
</body>
</html>
